<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">{- | This module was copied from the Liqwid-Labs/agora repo, and updated to work with Plutus V3 and Plutarch 1.10.1

 @since WIP
-}</span></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Agora.AuthorityToken</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agora.AuthorityToken.html#singleAuthorityTokenBurned"><span class="hs-identifier">singleAuthorityTokenBurned</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Agora.AuthorityToken.html#authorityTokensValidIn"><span class="hs-identifier">authorityTokensValidIn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Agora.Utils.html"><span class="hs-identifier">Agora.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Agora.Utils.html#psymbolValueOf"><span class="hs-identifier">psymbolValueOf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutarch.Builtin.Bool</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PBool</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutarch.LedgerApi.AssocMap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AssocMap</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutarch.LedgerApi.V3</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><span class="hs-identifier">AmountGuarantees</span></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="annot"><span class="hs-identifier">KeyGuarantees</span></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><span class="hs-identifier">PAddress</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PAddress</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="annot"><span class="hs-identifier">PCredential</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PPubKeyCredential</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PScriptCredential</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><span class="hs-identifier">PCurrencySymbol</span></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><span class="hs-identifier">PTxInInfo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PTxInInfo</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><span class="hs-identifier">PTxOut</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PTxOut</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><span class="hs-identifier">PValue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PValue</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutarch.Monadic</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutarch.Prelude</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><span class="hs-identifier">PAsData</span></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><span class="hs-identifier">PBool</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PTrue</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="hs-identifier">PBuiltinList</span></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><span class="hs-identifier">PEq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(#==)</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="hs-identifier">PInteger</span></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><span class="hs-identifier">PMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PJust</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PNothing</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><span class="hs-identifier">S</span></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><span class="hs-identifier">pcon</span></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><span class="hs-identifier">pconstant</span></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><span class="hs-identifier">pfoldr</span></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><span class="hs-identifier">pfromData</span></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><span class="hs-identifier">phoistAcyclic</span></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="hs-identifier">pif</span></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="hs-identifier">plam</span></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier">pmatch</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="hs-identifier">ptraceInfoIfFalse</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="hs-operator">(#)</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><span class="hs-operator">(#&amp;&amp;)</span></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="hs-operator">(:--&gt;)</span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="annot"><span class="hs-comment">{- | Check that all GATs are valid in a particular TxOut.

  WARNING: As of version 1.0.0, this has been weakened in order to be
  compatible with RATs. The token name is no longer checked, meaning that a
  GAT can escape from its effect script, if the effect script is vulnerable.
  In order to prevent this, all effect scripts should be implemented carefully,
  and ideally use the trusted effect base. See also 'Agora.Effect'.

  (before 1.0.0) How this is checked: an AuthorityToken should never leave
  the Effect it was initially sent to, so we simply check that
  the script address the token resides in matches the TokenName.
  Since the TokenName was tagged upon mint with the Effect script
  it was sent to, this is enough to prove validity.
  In other words, check that all assets of a particular currency symbol
  are tagged with a TokenName that matches where they live.

  @since WIP
-}</span></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Agora.AuthorityToken.html#authorityTokensValidIn"><span class="hs-identifier hs-type">authorityTokensValidIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679200542"><span class="annot"><a href="#local-6989586621679200542"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679200542"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PCurrencySymbol</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:--&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PTxOut</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:--&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PBool</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span id="authorityTokensValidIn"><span class="annot"><span class="annottext">authorityTokensValidIn :: forall (s :: S). Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool))
</span><a href="Agora.AuthorityToken.html#authorityTokensValidIn"><span class="hs-identifier hs-var hs-var">authorityTokensValidIn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall (s :: S).
 Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool)))
-&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool))
forall (a :: PType) (s :: S).
HasCallStack =&gt;
ClosedTerm a -&gt; Term s a
</span><span class="hs-identifier hs-var">phoistAcyclic</span></span><span> </span><span class="annot"><span class="annottext">((forall (s :: S).
  Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool)))
 -&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool)))
-&gt; (forall (s :: S).
    Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool)))
-&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="annottext">(Term s PCurrencySymbol -&gt; Term s PTxOut -&gt; Term s PBool)
-&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool))
forall a (b :: PType) (s :: S) (c :: PType).
(PLamN a b s, HasCallStack) =&gt;
(Term s c -&gt; a) -&gt; Term s (c :--&gt; b)
forall (c :: PType).
HasCallStack =&gt;
(Term s c -&gt; Term s PTxOut -&gt; Term s PBool)
-&gt; Term s (c :--&gt; (PTxOut :--&gt; PBool))
</span><span class="hs-identifier hs-var">plam</span></span><span> </span><span class="annot"><span class="annottext">((Term s PCurrencySymbol -&gt; Term s PTxOut -&gt; Term s PBool)
 -&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool)))
-&gt; (Term s PCurrencySymbol -&gt; Term s PTxOut -&gt; Term s PBool)
-&gt; Term s (PCurrencySymbol :--&gt; (PTxOut :--&gt; PBool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679200715"><span class="annot"><span class="annottext">Term s PCurrencySymbol
</span><a href="#local-6989586621679200715"><span class="hs-identifier hs-var">authorityTokenSym</span></a></span></span><span> </span><span id="local-6989586621679200716"><span class="annot"><span class="annottext">Term s PTxOut
</span><a href="#local-6989586621679200716"><span class="hs-identifier hs-var">txOut</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">P.do</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">PTxOut</span></span><span> </span><span id="local-6989586621679200717"><span class="annot"><span class="annottext">Term s PAddress
</span><a href="#local-6989586621679200717"><span class="hs-identifier hs-var">address</span></a></span></span><span> </span><span id="local-6989586621679200718"><span class="annot"><span class="annottext">Term s (PAsData (PValue 'Sorted 'Positive))
</span><a href="#local-6989586621679200718"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="annot"><span class="annottext">Term s POutputDatum
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term s (PMaybeData PScriptHash)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term s PTxOut -&gt; (PTxOut s -&gt; Term s PBool) -&gt; Term s PBool
forall (a :: PType) (s :: S) (b :: PType).
PlutusType a =&gt;
Term s a -&gt; (a s -&gt; Term s b) -&gt; Term s b
</span><span class="hs-identifier hs-var">pmatch</span></span><span> </span><span class="annot"><span class="annottext">Term s PTxOut
</span><a href="#local-6989586621679200716"><span class="hs-identifier hs-var">txOut</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">PAddress</span></span><span> </span><span id="local-6989586621679200719"><span class="annot"><span class="annottext">Term s PCredential
</span><a href="#local-6989586621679200719"><span class="hs-identifier hs-var">credential</span></a></span></span><span> </span><span class="annot"><span class="annottext">Term s (PMaybeData PStakingCredential)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term s PAddress -&gt; (PAddress s -&gt; Term s PBool) -&gt; Term s PBool
forall (a :: PType) (s :: S) (b :: PType).
PlutusType a =&gt;
Term s a -&gt; (a s -&gt; Term s b) -&gt; Term s b
</span><span class="hs-identifier hs-var">pmatch</span></span><span> </span><span class="annot"><span class="annottext">Term s PAddress
</span><a href="#local-6989586621679200717"><span class="hs-identifier hs-var">address</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">PValue</span></span><span> </span><span id="local-6989586621679200720"><span class="annot"><span class="annottext">Term
  s (PMap 'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger))
</span><a href="#local-6989586621679200720"><span class="hs-identifier hs-var">assetMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term s (PValue 'Sorted 'Positive)
-&gt; (PValue 'Sorted 'Positive s -&gt; Term s PBool) -&gt; Term s PBool
forall (a :: PType) (s :: S) (b :: PType).
PlutusType a =&gt;
Term s a -&gt; (a s -&gt; Term s b) -&gt; Term s b
</span><span class="hs-identifier hs-var">pmatch</span></span><span> </span><span class="annot"><span class="annottext">(Term s (PValue 'Sorted 'Positive)
 -&gt; (PValue 'Sorted 'Positive s -&gt; Term s PBool) -&gt; Term s PBool)
-&gt; Term s (PValue 'Sorted 'Positive)
-&gt; (PValue 'Sorted 'Positive s -&gt; Term s PBool)
-&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term s (PAsData (PValue 'Sorted 'Positive))
-&gt; Term s (PValue 'Sorted 'Positive)
forall (a :: PType) (s :: S).
PIsData a =&gt;
Term s (PAsData a) -&gt; Term s a
</span><span class="hs-identifier hs-var">pfromData</span></span><span> </span><span class="annot"><span class="annottext">Term s (PAsData (PValue 'Sorted 'Positive))
</span><a href="#local-6989586621679200718"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><span class="annottext">Term s (PMaybe (PMap 'Sorted PTokenName PInteger))
-&gt; (PMaybe (PMap 'Sorted PTokenName PInteger) s -&gt; Term s PBool)
-&gt; Term s PBool
forall (a :: PType) (s :: S) (b :: PType).
PlutusType a =&gt;
Term s a -&gt; (a s -&gt; Term s b) -&gt; Term s b
</span><span class="hs-identifier hs-var">pmatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term
  s
  (PCurrencySymbol
   :--&gt; (PMap
           'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger)
         :--&gt; PMaybe (PMap 'Sorted PTokenName PInteger)))
forall (k :: PType) (v :: PType) (any :: KeyGuarantees) (s :: S).
(PIsData k, PIsData v) =&gt;
Term s (k :--&gt; (PMap any k v :--&gt; PMaybe v))
</span><span class="hs-identifier hs-var">AssocMap.plookup</span></span><span> </span><span class="annot"><span class="annottext">Term
  s
  (PCurrencySymbol
   :--&gt; (PMap
           'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger)
         :--&gt; PMaybe (PMap 'Sorted PTokenName PInteger)))
-&gt; Term s PCurrencySymbol
-&gt; Term
     s
     (PMap 'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger)
      :--&gt; PMaybe (PMap 'Sorted PTokenName PInteger))
forall (s :: S) (a :: PType) (b :: PType).
Term s (a :--&gt; b) -&gt; Term s a -&gt; Term s b
</span><span class="hs-operator hs-var">#</span></span><span> </span><span class="annot"><span class="annottext">Term s PCurrencySymbol
</span><a href="#local-6989586621679200715"><span class="hs-identifier hs-var">authorityTokenSym</span></a></span><span> </span><span class="annot"><span class="annottext">Term
  s
  (PMap 'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger)
   :--&gt; PMaybe (PMap 'Sorted PTokenName PInteger))
-&gt; Term
     s (PMap 'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger))
-&gt; Term s (PMaybe (PMap 'Sorted PTokenName PInteger))
forall (s :: S) (a :: PType) (b :: PType).
Term s (a :--&gt; b) -&gt; Term s a -&gt; Term s b
</span><span class="hs-operator hs-var">#</span></span><span> </span><span class="annot"><span class="annottext">Term
  s (PMap 'Sorted PCurrencySymbol (PMap 'Sorted PTokenName PInteger))
</span><a href="#local-6989586621679200720"><span class="hs-identifier hs-var">assetMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PMaybe (PMap 'Sorted PTokenName PInteger) s -&gt; Term s PBool)
 -&gt; Term s PBool)
-&gt; (PMaybe (PMap 'Sorted PTokenName PInteger) s -&gt; Term s PBool)
-&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-69"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">PJust</span></span><span> </span><span id="local-6989586621679200722"><span class="annot"><span class="annottext">Term s (PMap 'Sorted PTokenName PInteger)
</span><a href="#local-6989586621679200722"><span class="hs-identifier hs-var">_tokenMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>        </span><span class="hs-comment">-- TODO: This check only needs to happen for outputs, not inputs (performance)</span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><span class="annottext">Term s PCredential
-&gt; (PCredential s -&gt; Term s PBool) -&gt; Term s PBool
forall (a :: PType) (s :: S) (b :: PType).
PlutusType a =&gt;
Term s a -&gt; (a s -&gt; Term s b) -&gt; Term s b
</span><span class="hs-identifier hs-var">pmatch</span></span><span> </span><span class="annot"><span class="annottext">Term s PCredential
</span><a href="#local-6989586621679200719"><span class="hs-identifier hs-var">credential</span></a></span><span> </span><span class="annot"><span class="annottext">((PCredential s -&gt; Term s PBool) -&gt; Term s PBool)
-&gt; (PCredential s -&gt; Term s PBool) -&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-72"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">PPubKeyCredential</span></span><span> </span><span class="annot"><span class="annottext">Term s (PAsData PPubKeyHash)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-73"></span><span>            </span><span class="hs-comment">-- GATs should only be sent to Effect validators</span><span>
</span><span id="line-74"></span><span>            </span><span class="annot"><span class="annottext">Term s PString -&gt; Term s PBool -&gt; Term s PBool
forall (s :: S). Term s PString -&gt; Term s PBool -&gt; Term s PBool
</span><span class="hs-identifier hs-var">ptraceInfoIfFalse</span></span><span> </span><span class="annot"><span class="annottext">Term s PString
</span><span class="hs-string">&quot;authorityTokensValidIn: GAT incorrectly lives at PubKey&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Term s PBool -&gt; Term s PBool) -&gt; Term s PBool -&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AsHaskell PBool -&gt; Term s PBool
forall (a :: PType) (s :: S).
PLiftable a =&gt;
AsHaskell a -&gt; Term s a
</span><span class="hs-identifier hs-var">pconstant</span></span><span> </span><span class="annot"><span class="annottext">Bool
AsHaskell PBool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-75"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">PScriptCredential</span></span><span> </span><span class="annot"><span class="annottext">Term s (PAsData PScriptHash)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>            </span><span class="hs-comment">-- NOTE: We no longer can perform a check on `TokenName` content here.</span><span>
</span><span id="line-77"></span><span>            </span><span class="hs-comment">-- Instead, the auth check system uses `TokenName`s, but it cannot</span><span>
</span><span id="line-78"></span><span>            </span><span class="hs-comment">-- check for GATs incorrectly escaping scripts. The effect scripts</span><span>
</span><span id="line-79"></span><span>            </span><span class="hs-comment">-- need to be written very carefully in order to disallow this.</span><span>
</span><span id="line-80"></span><span>            </span><span class="annot"><span class="annottext">PBool s -&gt; Term s PBool
forall (a :: PType) (s :: S). PlutusType a =&gt; a s -&gt; Term s a
</span><span class="hs-identifier hs-var">pcon</span></span><span> </span><span class="annot"><span class="annottext">PBool s
forall (s :: S). PBool s
</span><span class="hs-identifier hs-var">PTrue</span></span><span>
</span><span id="line-81"></span><span>      </span><span class="annot"><span class="annottext">PMaybe (PMap 'Sorted PTokenName PInteger) s
</span><span class="hs-identifier hs-var">PNothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-comment">-- No GATs exist at this output!</span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">PBool s -&gt; Term s PBool
forall (a :: PType) (s :: S). PlutusType a =&gt; a s -&gt; Term s a
</span><span class="hs-identifier hs-var">pcon</span></span><span> </span><span class="annot"><span class="annottext">PBool s
forall (s :: S). PBool s
</span><span class="hs-identifier hs-var">PTrue</span></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><span class="hs-comment">{- | Assert that a single authority token has been burned.

  @since WIP
-}</span></span><span>
</span><span id="line-89"></span><span class="annot"><a href="Agora.AuthorityToken.html#singleAuthorityTokenBurned"><span class="hs-identifier hs-type">singleAuthorityTokenBurned</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679200626"><span class="annot"><a href="#local-6989586621679200626"><span class="hs-identifier hs-type">keys</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeyGuarantees</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679200627"><span class="annot"><a href="#local-6989586621679200627"><span class="hs-identifier hs-type">amounts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AmountGuarantees</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679200623"><span class="annot"><a href="#local-6989586621679200623"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679200623"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PCurrencySymbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679200623"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PBuiltinList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PAsData</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PTxInInfo</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679200623"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PValue</span></span><span> </span><span class="annot"><a href="#local-6989586621679200626"><span class="hs-identifier hs-type">keys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679200627"><span class="hs-identifier hs-type">amounts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621679200623"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PBool</span></span><span>
</span><span id="line-95"></span><span id="singleAuthorityTokenBurned"><span class="annot"><span class="annottext">singleAuthorityTokenBurned :: forall (keys :: KeyGuarantees) (amounts :: AmountGuarantees)
       (s :: S).
Term s PCurrencySymbol
-&gt; Term s (PBuiltinList (PAsData PTxInInfo))
-&gt; Term s (PValue keys amounts)
-&gt; Term s PBool
</span><a href="Agora.AuthorityToken.html#singleAuthorityTokenBurned"><span class="hs-identifier hs-var hs-var">singleAuthorityTokenBurned</span></a></span></span><span> </span><span id="local-6989586621679200756"><span class="annot"><span class="annottext">Term s PCurrencySymbol
</span><a href="#local-6989586621679200756"><span class="hs-identifier hs-var">gatCs</span></a></span></span><span> </span><span id="local-6989586621679200757"><span class="annot"><span class="annottext">Term s (PBuiltinList (PAsData PTxInInfo))
</span><a href="#local-6989586621679200757"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621679200758"><span class="annot"><span class="annottext">Term s (PValue keys amounts)
</span><a href="#local-6989586621679200758"><span class="hs-identifier hs-var">mint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">P.do</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679200759"><span class="hs-identifier hs-type">gatAmountMinted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PInteger</span></span><span>
</span><span id="line-97"></span><span>      </span><span id="local-6989586621679200759"><span class="annot"><span class="annottext">gatAmountMinted :: Term s PInteger
</span><a href="#local-6989586621679200759"><span class="hs-identifier hs-var hs-var">gatAmountMinted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term s (PCurrencySymbol :--&gt; (PValue keys amounts :--&gt; PInteger))
forall (keys :: KeyGuarantees) (amounts :: AmountGuarantees)
       (s :: S).
Term s (PCurrencySymbol :--&gt; (PValue keys amounts :--&gt; PInteger))
</span><a href="Agora.Utils.html#psymbolValueOf"><span class="hs-identifier hs-var">psymbolValueOf</span></a></span><span> </span><span class="annot"><span class="annottext">Term s (PCurrencySymbol :--&gt; (PValue keys amounts :--&gt; PInteger))
-&gt; Term s PCurrencySymbol
-&gt; Term s (PValue keys amounts :--&gt; PInteger)
forall (s :: S) (a :: PType) (b :: PType).
Term s (a :--&gt; b) -&gt; Term s a -&gt; Term s b
</span><span class="hs-operator hs-var">#</span></span><span> </span><span class="annot"><span class="annottext">Term s PCurrencySymbol
</span><a href="#local-6989586621679200756"><span class="hs-identifier hs-var">gatCs</span></a></span><span> </span><span class="annot"><span class="annottext">Term s (PValue keys amounts :--&gt; PInteger)
-&gt; Term s (PValue keys amounts) -&gt; Term s PInteger
forall (s :: S) (a :: PType) (b :: PType).
Term s (a :--&gt; b) -&gt; Term s a -&gt; Term s b
</span><span class="hs-operator hs-var">#</span></span><span> </span><span class="annot"><span class="annottext">Term s (PValue keys amounts)
</span><a href="#local-6989586621679200758"><span class="hs-identifier hs-var">mint</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679200760"><span class="annot"><span class="annottext">inputsWithGAT :: Term s PInteger
</span><a href="#local-6989586621679200760"><span class="hs-identifier hs-var hs-var">inputsWithGAT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">Term
  s
  ((PAsData PTxInInfo :--&gt; (PInteger :--&gt; PInteger))
   :--&gt; (PInteger
         :--&gt; (PBuiltinList (PAsData PTxInInfo) :--&gt; PInteger)))
forall (list :: PType -&gt; PType) (a :: PType) (s :: S) (b :: PType).
PIsListLike list a =&gt;
Term s ((a :--&gt; (b :--&gt; b)) :--&gt; (b :--&gt; (list a :--&gt; b)))
</span><span class="hs-identifier hs-var">pfoldr</span></span><span class="hs-cpp">
          # plam
</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">input</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pmatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pfromData</span><span> </span><span class="hs-identifier">input</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-103"></span><span>                </span><span class="hs-identifier">PTxInInfo</span><span> </span><span class="hs-identifier">_txOutRef</span><span> </span><span class="hs-identifier">resolved</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>                  </span><span class="hs-identifier">pif</span><span>
</span><span id="line-105"></span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier">authorityTokensValidIn</span><span> </span><span class="hs-operator">#</span><span> </span><span class="hs-identifier">gatCs</span><span> </span><span class="hs-operator">#</span><span> </span><span class="hs-identifier">resolved</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">P.do</span><span>
</span><span id="line-107"></span><span>                        </span><span class="hs-identifier">PTxOut</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">value</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">pmatch</span><span> </span><span class="hs-identifier">resolved</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>                        </span><span class="hs-identifier">v</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">psymbolValueOf</span><span> </span><span class="hs-operator">#</span><span> </span><span class="hs-identifier">gatCs</span><span> </span><span class="hs-operator">#</span><span> </span><span class="hs-identifier">pfromData</span><span> </span><span class="hs-identifier">value</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier">P.fail</span><span> </span><span class="hs-string">&quot;While counting GATs at inputs: all GATs must be valid&quot;</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>            </span><span class="hs-special">)</span><span class="hs-cpp">
          # 0
</span><span class="hs-cpp">          # inputs
</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">(Term s PBool -&gt; Term s PBool -&gt; Term s PBool)
-&gt; [Term s PBool] -&gt; Term s PBool
forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
forall (t :: Type -&gt; Type) a.
Foldable t =&gt;
(a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#foldr1"><span class="hs-identifier hs-var">foldr1</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">Term s PBool -&gt; Term s PBool -&gt; Term s PBool
forall (s :: S). Term s PBool -&gt; Term s PBool -&gt; Term s PBool
</span><span class="hs-operator hs-var">(#&amp;&amp;)</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Term s PString -&gt; Term s PBool -&gt; Term s PBool
forall (s :: S). Term s PString -&gt; Term s PBool -&gt; Term s PBool
</span><span class="hs-identifier hs-var">ptraceInfoIfFalse</span></span><span> </span><span class="annot"><span class="annottext">Term s PString
</span><span class="hs-string">&quot;singleAuthorityTokenBurned: Must burn exactly 1 GAT&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Term s PBool -&gt; Term s PBool) -&gt; Term s PBool -&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">Term s PInteger
</span><a href="#local-6989586621679200759"><span class="hs-identifier hs-var">gatAmountMinted</span></a></span><span> </span><span class="annot"><span class="annottext">Term s PInteger -&gt; Term s PInteger -&gt; Term s PBool
forall (s :: S). Term s PInteger -&gt; Term s PInteger -&gt; Term s PBool
forall (t :: PType) (s :: S).
PEq t =&gt;
Term s t -&gt; Term s t -&gt; Term s PBool
</span><span class="hs-operator hs-var">#==</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Term s PInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term s PString -&gt; Term s PBool -&gt; Term s PBool
forall (s :: S). Term s PString -&gt; Term s PBool -&gt; Term s PBool
</span><span class="hs-identifier hs-var">ptraceInfoIfFalse</span></span><span> </span><span class="annot"><span class="annottext">Term s PString
</span><span class="hs-string">&quot;Only one GAT must exist at the inputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Term s PBool -&gt; Term s PBool) -&gt; Term s PBool -&gt; Term s PBool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-121"></span><span>        </span><span class="annot"><span class="annottext">Term s PInteger
</span><a href="#local-6989586621679200760"><span class="hs-identifier hs-var">inputsWithGAT</span></a></span><span> </span><span class="annot"><span class="annottext">Term s PInteger -&gt; Term s PInteger -&gt; Term s PBool
forall (s :: S). Term s PInteger -&gt; Term s PInteger -&gt; Term s PBool
forall (t :: PType) (s :: S).
PEq t =&gt;
Term s t -&gt; Term s t -&gt; Term s PBool
</span><span class="hs-operator hs-var">#==</span></span><span> </span><span class="annot"><span class="annottext">Term s PInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-123"></span></pre></body></html>